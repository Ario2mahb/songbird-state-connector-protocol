# Code Generation Command Line tool

A part of this repo is a CLI tool `Flare Connector Utils`, which is used to generate certain configurations and code for various purposes.
Attestation types are described in terms of Solidity interfaces in folder `contract/interface/types`.
[Hardhat](https://hardhat.org/) is integrated into this repository for interface compilation and contract management purposes.

## Supported outputs

The following code generation outputs are available:

-   Attestation type configs with JSON ABI definitions for structs of attestation requests, responses and proofs.
-   Verification contracts with Solidity code for proving attestation responses against the corresponding Merkle roots.
-   Typescript types for requests, responses and proofs of attestation types.
-   Documentation of attestation types in Markdown
-   Tests for verifying contracts
-   Test example generation code for structures.
-   Test examples of randomly generated structures for usage in simple tests.

In addition, the tool is compatible with the [Verifier Server Template](https://gitlab.com/flarenetwork/verifier-server-template) where it acts as a CLI that provides configurations and supporting code for specific attestation types.
This includes specific attestation type handling libraries, [Nest.js](https://nestjs.com/) data transfer objects (DTO) for requests and responses on API routes, controller and service object and test examples.

In a similar role, the tool can be used to support development of specific attestation types on the [Attestation Client](https://gitlab.com/flarenetwork/attestation-client) repository, which implements several verifier servers for certain attestation types and data sources.

### Basic configurations for attestation types

Configuration for an attestation type is a JSON file that contains metadata extracted from the attestation type Solidity interface definition and JSON ABI definitions for attestation request, response and proof structs.
The metadata fully describing all data structures relevant for the attestation type with comments and some additional annotations.
The data structures are extracted from Solidity structs while other metadata is extracted from [NatSpec](https://docs.soliditylang.org/en/v0.8.20/natspec-format.html) compatible comments.
Note that several custom tags in [NatSpec](https://docs.soliditylang.org/en/v0.8.20/natspec-format.html) comments in the Solidity interfaces describe relevant metadata.
The structure of the JSON file is described through the [TypeRecord](/libs/ts/config-types.ts) type.
These configurations can be used in third party applications as full definitions of attestation types.

All configurations can be generated by calling:

```
yarn generate config
```

The configs are generated into the folder `generated/configs`.
The Typescript types matching to the configs are available [here](../../libs/ts/config-types.ts).
The toplevel type is `TypeRecord`.
For further usage see:

```
yarn generate config --help
```

### Verification contracts

For each attestation type, a [verification smart contract](/specs/attestations/verification-contract.md) can be generated.
Such a contract can be initialized in constructor an instance of a contract supporting [`IMerkleRootStorage`](/contracts/interface/external/IMerkleRootStorage.sol) interface, essentially providing access to an array of confirmed Merkle roots indexed
by voting round ids.
The generated verification contract contains a verification function with the name of the form `verify<attestationTypeName>(proof)`, which accepts a proof in the struct matching the attestation type and returns `true` if the proof is correct (successfully checked against the Merkle root in Merkle root storage (or State Connector contract)).

For usage see:

```bash
yarn generate verification-contract --help
```

### Typescript types for requests, responses and proofs

Based on attestation type configurations, Typescript type definitions for relevant data objects can be generated.

For usage see:

```bash
yarn generate ts-type --help
```

### Markdown documentation

Markdown documentation for attestation types can be generated from basic configurations.
For this purpose, NatSpec comments Solidity interfaces defining the types need specific tags.
The following tags are used on the interface (attestation type) level.

-   `@custom:name`: Attestation type name. Should match the interface name and the file name without the `.sol` extension
-   `@custom:id`: Attestation type ID. A number, can be in `0x` hex notation.
-   `@custom:supported`: A comma separated (with possible spaces around) list of alpha numeric symbols that identify data source ids. Currently supported: `BTC`, `DOGE`, `XRP`, `ETH`.
-   `@author`: Standard NatSpec author definition tag.
-   `@notice`: Standard NatSpec description tag.
-   `@custom:verification`: Markdown text, usually multiline, that describes attestation type verification rules.
-   `@custom:lut`: Field name that is used for lowest used timestamp.

On the level of structs in the interface, we have the following tags:

-   `@notice`: Description/comment of the struct
-   `@param`: Description of the member variable in a struct. Should be followed with the member variable name matching the name in the struct. Tags `@param` should follow in the same order as the corresponding member variables.

For usage see:

```bash
yarn generate md --help
```

### Test example generation code for structures

Code for generating request and response structures filled with random values can be generated for each attestation type.

```
yarn generate test-examples-ts --help
```

### Test examples of randomly generated structures

Examples of randomly filled request and response structures can be generated.
Examples are provided in JSON files.

```bash
yarn generate test-examples-json --help
```

### Tests for verification contracts

Tests are generated for verification contracts with random responses, Merkle trees and corresponding proofs.

For usage see:

```
yarn generate verification-contract-test --help
```

### Verifier server template object generation

Based on attestation type definitions it generates relevant classes, examples, services, controllers and helper libraries into the verifier server template.
For further usage see:

```bash
yarn generate verifier-template-refresh --help
```

For the development of Attestation client, assuming that the repo is at `'../attestation-client`, to refresh the libraries and attestation type definitions one can use:

```bash
yarn generate verifier-template-refresh -a -p STATE_CONNECTOR -r ../attestation-client
```

To refresh verifier servers in the attestation client repo, use:

```bash
yarn generate verifier-template-refresh -v -p STATE_CONNECTOR -r ../attestation-client -x -s
```

For developers of EVM verifier, relevant code updates for additional networks are done by calling the following and providing specific data source instead of `ETH,SGB,FLR`.

```bash
yarn generate verifier-template-refresh -t EVMTransaction -d ETH,SGB,FLR -r ../evm-verifier -s -i
```

[Home](/README.md)
